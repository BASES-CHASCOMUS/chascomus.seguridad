<!doctype html>
<html lang=es>
<head>
<meta charset=utf-8>
<meta name=viewport content="width=device-width,initial-scale=1">
<title>⚖️ Sistema de Registro Judicial</title>
<style>
:root {
  --primary: #8b5cf6;
  --primary-light: #a78bfa;
  --dark: #0f172a;
  --light: #f8fafc;
  --gray: #64748b;
  --success: #10b981;
  --warning: #f59e0b;
  --error: #ef4444;
  --bg: #0f172a;
  --card: #1e293b;
  --text: #f8fafc;
  --border: #334155;
  --detail-bg: #1e293b;
  --detail-header: #334155;
  --section-blue: rgba(59, 130, 246, 0.1);
  --section-purple: rgba(139, 92, 246, 0.1);
  --section-green: rgba(16, 185, 129, 0.1);
  --section-amber: rgba(245, 158, 11, 0.1);
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
  font-family: 'Inter', sans-serif;
}

body {
  background-color: var(--bg);
  color: var(--text);
  min-height: 100vh;
  padding: 20px;
  line-height: 1.5;
}

.container {
  max-width: 1200px;
  margin: 0 auto;
}

header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  flex-wrap: wrap;
  gap: 15px;
}

h1 {
  color: var(--primary);
  font-size: 28px;
  font-weight: 700;
  display: flex;
  align-items: center;
  gap: 10px;
}

.alert-panel {
  background-color: var(--warning);
  color: white;
  padding: 15px;
  border-radius: 8px;
  margin-bottom: 20px;
  display: flex;
  align-items: center;
  gap: 10px;
  animation: pulse 2s infinite;
  cursor: pointer;
}

@keyframes pulse {
  0% { opacity: 1 }
  50% { opacity: .8 }
  100% { opacity: 1 }
}

.review-badge {
  background-color: var(--error);
  color: white;
  border-radius: 50%;
  width: 25px;
  height: 25px;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: 700;
  margin-left: 10px;
}

.form-container {
  background-color: var(--card);
  border-radius: 16px;
  box-shadow: 0 10px 30px rgba(0,0,0,.1);
  padding: 30px;
  border: 1px solid var(--border);
  margin-bottom: 30px;
}

.form-group {
  margin-bottom: 20px;
  position: relative;
}

label {
  display: block;
  margin-bottom: 8px;
  font-weight: 500;
  color: var(--text);
}

input, textarea, select {
  width: 100%;
  padding: 12px 16px;
  border: 2px solid var(--border);
  border-radius: 8px;
  font-size: 16px;
  background-color: var(--card);
  color: var(--text);
  transition: all 0.3s ease;
}

input:focus, textarea:focus, select:focus {
  border-color: var(--primary-light);
  outline: none;
  box-shadow: 0 0 0 3px rgba(139,92,246,0.2);
}

.date-time-range {
  display: flex;
  gap: 16px;
  flex-wrap: wrap;
}

.date-time-range > div {
  flex: 1;
  min-width: 150px;
}

button {
  background-color: var(--primary);
  color: white;
  border: none;
  padding: 14px 24px;
  border-radius: 8px;
  font-size: 16px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 10px;
  transition: all 0.3s ease;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

button:hover {
  transform: translateY(-2px);
  box-shadow: 0 6px 10px rgba(0,0,0,0.2);
  opacity: 0.9;
}

.save-button {
  background-color: var(--success);
}

.save-button:hover {
  background-color: #0d9f6e;
}

.sheets-button {
  background-color: #34a853;
  margin-bottom: 20px;
  width: 100%;
}

.sheets-button:hover {
  background-color: #2d8e47;
}

.analysis-button {
  background-color: #9333ea;
}

.analysis-button:hover {
  background-color: #7e22ce;
}

.message {
  padding: 16px;
  border-radius: 8px;
  margin-top: 20px;
  text-align: center;
  display: none;
}

.success {
  background-color: var(--success);
  color: white;
}

.error {
  background-color: var(--error);
  color: white;
}

.hidden {
  display: none;
}

.calle-periodo-group {
  margin-bottom: 15px;
  border: 1px solid var(--border);
  padding: 15px;
  border-radius: 8px;
  transition: all 0.3s ease;
}

.calle-periodo-group:hover {
  border-color: var(--primary-light);
}

.eliminar-calle {
  background-color: var(--error) !important;
  margin-top: 10px;
  padding: 8px 12px !important;
  font-size: 14px !important;
}

.eliminar-calle:hover {
  background-color: #dc2626 !important;
}

.campos-extra {
  background-color: rgba(139,92,246,0.1);
  padding: 15px;
  border-radius: 8px;
  margin-top: 20px;
  border: 1px dashed var(--primary);
  transition: all 0.3s ease;
}

.campos-extra:hover {
  border-color: var(--primary-light);
}

.field-alert {
  position: absolute;
  bottom: -20px;
  left: 0;
  font-size: 12px;
  padding: 4px 8px;
  border-radius: 4px;
  display: none;
  transition: all 0.3s ease;
}

.alert-warning {
  background-color: var(--warning);
  color: white;
}

.alert-error {
  background-color: var(--error);
  color: white;
}

.has-warning {
  border-color: var(--warning) !important;
}

.has-error {
  border-color: var(--error) !important;
}

.modal-overlay {
  display: none;
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background-color: rgba(0,0,0,0.7);
  z-index: 1000;
  justify-content: center;
  align-items: center;
}

.modal-success {
  background-color: var(--success);
  padding: 30px;
  border-radius: 10px;
  text-align: center;
  max-width: 400px;
  width: 90%;
  box-shadow: 0 5px 15px rgba(0,0,0,0.3);
}

table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th {
  background-color: var(--primary);
  color: white;
  padding: 12px;
  text-align: left;
}

td {
  padding: 12px;
  border-bottom: 1px solid var(--border);
}

tr:hover {
  background-color: rgba(255,255,255,0.05);
}

.detalle-row {
  display: none;
}

.detalle-row.visible {
  display: table-row;
}

.detalle-content {
  background-color: var(--detail-bg);
  padding: 20px;
  border-radius: 8px;
  margin: 10px 0;
  box-shadow: 0 4px 6px rgba(0,0,0,0.1);
}

.detalle-section {
  padding: 15px;
  border-radius: 6px;
  margin-bottom: 15px;
}

.detalle-section h4 {
  color: var(--primary-light);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 15px;
}

.detalle-section p {
  margin: 8px 0;
  line-height: 1.5;
  white-space: pre-line;
}

.detalle-grid {
  display: grid;
  grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
  gap: 20px;
}

.section-camaras {
  background-color: var(--section-purple);
  border-left: 4px solid var(--primary);
}

.section-estado {
  background-color: var(--section-green);
  border-left: 4px solid var(--success);
}

.section-calles {
  background-color: var(--section-blue);
  border-left: 4px solid #3b82f6;
}

.section-periodo {
  background-color: var(--section-amber);
  border-left: 4px solid var(--warning);
}

.section-fecha {
  background-color: rgba(99, 102, 241, 0.1);
  border-left: 4px solid #6366f1;
}

.section-observaciones {
  background-color: rgba(236, 72, 153, 0.1);
  border-left: 4px solid #ec4899;
}

/* ESTILOS CORREGIDOS PARA LOS BOTONES */
.header-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.header-buttons button {
  margin: 0;
  white-space: nowrap;
}

@media (max-width: 768px) {
  .date-time-range {
    flex-direction: column;
    gap: 10px;
  }
  
  .alert-panel {
    flex-direction: column;
    align-items: flex-start;
  }
  
  th, td {
    padding: 8px;
  }
  
  .detalle-grid {
    grid-template-columns: 1fr;
  }
  
  header {
    flex-direction: column;
    align-items: flex-start;
  }
  
  h1 {
    font-size: 24px;
  }
  
  .header-buttons {
    width: 100%;
    justify-content: space-between;
  }
  
  .header-buttons button {
    flex: 1;
    min-width: 100px;
    padding: 12px 16px;
    font-size: 14px;
  }
}

@media (max-width: 480px) {
  .header-buttons {
    flex-direction: column;
    width: 100%;
  }
  
  .header-buttons button {
    width: 100%;
  }
}
</style>
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel=stylesheet>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel=stylesheet>
</head>
<body>
<div class=container>
<div id=reviewAlert class="alert-panel hidden" onclick='window.open("https://docs.google.com/spreadsheets/d/1rmxYCNVaNZM6xjUij4GcMrMrkCwyVs5Gr9mZWB4oJdc/edit?gid=1709665157#gid=1709665157&filter=numero_oficio:~%23","_blank")'>
<i class="fas fa-exclamation-triangle"></i>
<span>Casos Pendientes de Revisión: </span>
<span id=pendingCasesCount class=review-badge>0</span>
<span style="margin-left:auto;font-size:.9em">(Click para ver)</span>
</div>

<header>
<h1><i class="fas fa-file-contract"></i> Sistema de Registro Judicial | Municipio de Chascomús</h1>
<div class="header-buttons">
    <button id=btnCargar class=save-button>
        <i class="fas fa-plus"></i> Cargar
    </button>
    <button id=btnBuscar class=sheets-button>
        <i class="fas fa-search"></i> Buscar
    </button>
    <button id=btnAnalisis class="analysis-button" onclick='window.open("https://javiergar900.github.io/dispositivos-eficacia/","_blank")'>
        <i class="fas fa-chart-bar"></i> Análisis
    </button>
</div>
</header>

<div class=form-container id=formCargar>
<form id=oficioForm>
<button type=button class=sheets-button onclick='window.open("https://docs.google.com/spreadsheets/d/1rmxYCNVaNZM6xjUij4GcMrMrkCwyVs5Gr9mZWB4oJdc/edit?gid=1709665157#gid=1709665157","_blank")'>
<i class="fab fa-google-drive"></i> Ver Hoja de calculo
</button>

<div class=form-group>
<label for=numero_oficio>N° de Oficio *</label>
<input type=text id=numero_oficio required placeholder="IPP N°.....">
<div id=numero_oficio_alert class="field-alert alert-warning">
<i class="fas fa-exclamation-triangle"></i>  Este Oficio se cargará de forma provisoria y se contabilizará en el alerta (#). Recuerda actualizarlo luego.
</div>
</div>

<div class=form-group>
<label for=numero_identificacion>N° Unico de Identificación *</label>
<input type=text id=numero_identificacion required placeholder="Ej: IPP N°...">
<div id=numero_identificacion_alert class="field-alert alert-error">
<i class="fas fa-times-circle"></i>  Este número ya existe en el sistema.
</div>
</div>

<div class=form-group>
<label for=fiscalia>Fiscalía Interviniente *</label>
<select id=fiscalia required onchange=mostrarCampoOtraFiscalia()>
<option value="">Seleccione...</option>
<option value="U.F.I N°10">U.F.I N°10</option>
<option value="U.F.I N°9">U.F.I N°9</option>
<option value="ESPECIALIZADA EN NARCOTRÁFICO">ESP. NARCOTRÁFICO</option>
<option value=OTRO>OTRO (Especificar)</option>
</select>
</div>

<div id=otraFiscaliaGroup class="form-group hidden">
<label for=otra_fiscalia>Especifique *</label>
<input type=text id=otra_fiscalia>
</div>

<div class=form-group>
<label for=caratula>Carátula *</label>
<input type=text id=caratula required placeholder="Ej: Robo agravado">
</div>

<div class=form-group>
<label>Calles y Períodos Solicitados *</label>
<div id=calles-container>
<div class=calle-periodo-group>
<div class=form-group>
<label>Calle(s)</label>
<textarea class=calle-text rows=2 required placeholder="Ej: Av. Lastra 1200"></textarea>
</div>
<div class=date-time-range>
<div>
<label>Fecha Inicio</label>
<input type=date class=fecha-inicio required>
</div>
<div>
<label>Hora Inicio</label>
<input type=time class=hora-inicio required>
</div>
<div>
<label>Fecha Fin</label>
<input type=date class=fecha-fin required>
</div>
<div>
<label>Hora Fin</label>
<input type=time class=hora-fin required>
</div>
</div>
</div>
</div>
<button type=button id=agregar-calle style="margin-top:10px">
<i class="fas fa-plus"></i> Agregar otra calle
</button>
</div>

<div class=campos-extra>
<div class=form-group>
<label for=camaras_aportadas>🎥 Cámaras Aportadas  *</label>
<textarea id=camaras_aportadas rows=3 required placeholder="Códigos de cámaras"></textarea>
</div>
<div class=form-group>
<label for=observaciones>📝 Observaciones</label>
<textarea id=observaciones rows=2 placeholder="Detalles..."></textarea>
</div>
</div>

<div class=form-group>
<label for=estado_material>Estado del Material Filmico       *</label>
<select id=estado_material required onchange=mostrarCamposEstado()>
<option value="">Seleccione...</option>
<option value="Entrega Normal">Entrega Normal</option>
<option value="Rechazado por Irregularidades">Rechazado</option>
<option value="No se dispone de material"> Material No disponible</option>
</select>
</div>

<div id=motivoRechazoGroup class="form-group hidden">
<label for=motivo_rechazo>Motivo de Rechazo *</label>
<textarea id=motivo_rechazo rows=2 placeholder="Irregularidades..."></textarea>
</div>

<div id=tipoNoDisponibleGroup class="form-group hidden">
<label for=tipo_no_disponible>Tipo *</label>
<select id=tipo_no_disponible>
<option value="">Seleccione...</option>
<option value="Cámara sin funcionamiento">Cámara sin funcionamiento</option>
<option value="No hay cámaras">Sin cámaras</option>
<option value="No se visualiza el evento">No se visualiza el evento</option>
</select>
</div>

<button type=submit class=save-button><i class="fas fa-save"></i> Guardar</button>
</form>
<div class="message success" id=successMessage>
<i class="fas fa-check-circle"></i> Oficio guardado
</div>
<div class="message error" id=errorMessage>
<i class="fas fa-exclamation-circle"></i> Error al guardar
</div>
</div>

<div class=form-container id=formBuscar style="display:none">
<h2><i class="fas fa-search"></i> Buscar Oficios</h2>

<div class=form-group>
<label for=buscarTexto>Buscar por N° de Oficio, Fiscalía o Carátula</label>
<input type=text id=buscarTexto placeholder="Ej: IPP N°... / U.F.I N°10 / Robo...">
</div>

<div class=form-group>
<label for=buscarIdentificacion>Buscar por N° de Identificación</label>
<input type=text id=buscarIdentificacion placeholder="Ej: IPP N°...">
</div>

<div class=date-time-range>
<div class=form-group>
<label for=fechaDesde>Desde</label>
<input type=date id=fechaDesde>
</div>
<div class=form-group>
<label for=fechaHasta>Hasta</label>
<input type=date id=fechaHasta>
</div>
</div>

<button id=btnBuscarOficios class=save-button>
<i class="fas fa-search"></i> Buscar
</button>

<div id=resultados style="margin-top:20px">
<table>
<thead>
<tr>
<th style="width:120px">N° Oficio</th>
<th style="width:100px">Fecha</th>
<th>N° Identificación</th>
<th>Carátula</th>
<th>Fiscalía</th>
<th style="width:50px"></th>
</tr>
</thead>
<tbody id=tablaResultados>
</tbody>
</table>
</div>
</div>
</div>

<div id=successModal class=modal-overlay>
<div class=modal-success>
<h3><i class="fas fa-check-circle"></i> ¡Éxito!</h3>
<p>El oficio se ha guardado correctamente</p>
<button onclick="document.getElementById('successModal').style.display='none'" style="margin-top:15px;width:100%">Aceptar</button>
</div>
</div>

<script>
const SHEETBEST_URL = "https://api.sheetbest.com/sheets/87fb9cab-586c-4ace-ab7b-ad1a399cbee2/tabs/Reportes-Judiciales";
let existingData = [];
let pendingCases = 0;

function mostrarCampoOtraFiscalia() {
    const fiscaliaSelect = document.getElementById("fiscalia");
    const otraFiscaliaGroup = document.getElementById("otraFiscaliaGroup");
    
    if (fiscaliaSelect.value === "OTRO") {
        otraFiscaliaGroup.classList.remove("hidden");
    } else {
        otraFiscaliaGroup.classList.add("hidden");
        document.getElementById("otra_fiscalia").value = ""; 
    }
}

document.addEventListener("DOMContentLoaded", async () => {
    try {
        const response = await fetch(SHEETBEST_URL);
        existingData = await response.json();
        existingData.forEach(item => {
            if(item.fecha_carga) {
                const [fecha, hora] = item.fecha_carga.split(' ');
                const [dia, mes, anio] = fecha.split('/');
                item.fechaObj = new Date(`${mes}/${dia}/${anio}`);
            }
        });
        updatePendingCases();
        setupFieldMonitoring();
    } catch(error) {
        console.error("Error:", error);
        document.getElementById("errorMessage").style.display = "block";
    }
});

document.getElementById("btnCargar").addEventListener("click", () => {
    document.getElementById("formCargar").style.display = "block";
    document.getElementById("formBuscar").style.display = "none";
});

document.getElementById("btnBuscar").addEventListener("click", () => {
    document.getElementById("formCargar").style.display = "none";
    document.getElementById("formBuscar").style.display = "block";
    mostrarResultados(existingData);
});

document.getElementById("btnBuscarOficios").addEventListener("click", () => {
    const texto = document.getElementById("buscarTexto").value.toLowerCase();
    const identificacion = document.getElementById("buscarIdentificacion").value.toLowerCase();
    const desde = document.getElementById("fechaDesde").value;
    const hasta = document.getElementById("fechaHasta").value;
    
    const resultados = existingData.filter(item => {
        const cumpleTexto = texto ?
            (item.numero_oficio?.toLowerCase().includes(texto) ||
             item.fiscalia?.toLowerCase().includes(texto) ||
             item.caratula?.toLowerCase().includes(texto)) : true;
        
        const cumpleIdentificacion = identificacion ?
            item.numero_identificacion?.toLowerCase().includes(identificacion) : true;
        
        let cumpleFecha = true;
        if(desde && hasta && item.fechaObj) {
            const desdeDate = new Date(desde);
            const hastaDate = new Date(hasta);
            cumpleFecha = item.fechaObj >= desdeDate && item.fechaObj <= hastaDate;
        }
        
        return cumpleTexto && cumpleIdentificacion && cumpleFecha;
    });
    
    mostrarResultados(resultados);
});

function mostrarResultados(data) {
    const tbody = document.getElementById("tablaResultados");
    tbody.innerHTML = "";
    
    if(data.length === 0) {
        tbody.innerHTML = `<tr><td colspan=6 style="text-align:center;padding:20px">No se encontraron resultados</td></tr>`;
        return;
    }
    
    data.forEach((item, index) => {
        const tr = document.createElement("tr");
        tr.style.cursor = "pointer";
        tr.innerHTML = `
            <td>${item.numero_oficio || "-"}</td>
            <td>${item.fecha_carga?.split(' ')[0] || "-"}</td>
            <td>${item.numero_identificacion || "-"}</td>
            <td>${item.caratula || "-"}</td>
            <td>${item.fiscalia || "-"}</td>
            <td style="text-align:center"><i class="fas fa-chevron-down"></i></td>
        `;
        
        const trDetalle = document.createElement("tr");
        trDetalle.className = "detalle-row";
        trDetalle.innerHTML = `
            <td colspan=6>
                <div class="detalle-content">
                    <div class="detalle-grid">
                        <div class="detalle-section section-camaras">
                            <h4><i class="fas fa-video"></i> Cámaras aportadas</h4>
                            <p>${item.camaras_aportadas || "No especificado"}</p>
                        </div>
                        <div class="detalle-section section-estado">
                            <h4><i class="fas fa-info-circle"></i> Estado del material</h4>
                            <p>${item.estado_material || "No especificado"}</p>
                        </div>
                        <div class="detalle-section section-calles">
                            <h4><i class="fas fa-road"></i> Calles solicitadas</h4>
                            <p>${item.calles || "No especificado"}</p>
                        </div>
                        <div class="detalle-section section-periodo">
                            <h4><i class="fas fa-clock"></i> Período solicitado</h4>
                            <p>${item.fecha_inicio ? `${formatDate(item.fecha_inicio)} ${item.hora_inicio || ""}` : "No especificado"} <strong>Hasta</strong> ${item.fecha_fin ? `${formatDate(item.fecha_fin)} ${item.hora_fin || ""}` : "No especificado"}</p>
                        </div>
                        <div class="detalle-section section-fecha">
                            <h4><i class="fas fa-calendar-day"></i> Fecha de carga</h4>
                            <p>${item.fecha_carga || "No especificado"}</p>
                        </div>
                        <div class="detalle-section section-observaciones">
                            <h4><i class="fas fa-comment-alt"></i> Observaciones</h4>
                            <p>${item.observaciones || "Sin observaciones"}</p>
                        </div>
                    </div>
                </div>
            </td>
        `;
        
        tr.addEventListener("click", () => {
            trDetalle.classList.toggle("visible");
            const icon = tr.querySelector("i");
            icon.classList.toggle("fa-chevron-down");
            icon.classList.toggle("fa-chevron-up");
        });
        
        tbody.appendChild(tr);
        tbody.appendChild(trDetalle);
    });
}

function formatDate(dateString) {
    if(!dateString) return "";
    const date = new Date(dateString);
    if(isNaN(date.getTime())) {
        const [year, month, day] = dateString.split('-');
        if(year && month && day) {
            return `${day}/${month}/${year}`;
        }
        return dateString; 
    }
    const day = date.getDate().toString().padStart(2, '0');
    const month = (date.getMonth() + 1).toString().padStart(2, '0');
    const year = date.getFullYear();
    return `${day}/${month}/${year}`;
}

function mostrarCamposEstado() {
    const estado = document.getElementById("estado_material").value;
    
    document.getElementById("motivoRechazoGroup").classList.add("hidden");
    document.getElementById("tipoNoDisponibleGroup").classList.add("hidden");

    if(estado === "Rechazado por Irregularidades") {
        document.getElementById("motivoRechazoGroup").classList.remove("hidden");
    } else if(estado === "No se dispone de material") {
        document.getElementById("tipoNoDisponibleGroup").classList.remove("hidden");
    }
}

function updatePendingCases() {
    pendingCases = existingData.filter(item =>
        item.numero_oficio && item.numero_oficio.includes("#")
    ).length;
    
    const alertPanel = document.getElementById("reviewAlert");
    const countBadge = document.getElementById("pendingCasesCount");
    
    countBadge.textContent = pendingCases;
    
    if(pendingCases > 0) {
        alertPanel.classList.remove("hidden");
    } else {
        alertPanel.classList.add("hidden");
    }
}

function setupFieldMonitoring() {
    const numeroOficioInput = document.getElementById("numero_oficio");
    const numeroOficioAlert = document.getElementById("numero_oficio_alert");
    
    numeroOficioInput.addEventListener("input", function() {
        if(this.value.includes("#")) {
            this.classList.add("has-warning");
            numeroOficioAlert.style.display = "block";
        } else {
            this.classList.remove("has-warning");
            numeroOficioAlert.style.display = "none";
        }
    });

    const numeroIdInput = document.getElementById("numero_identificacion");
    const numeroIdAlert = document.getElementById("numero_identificacion_alert");
    
    numeroIdInput.addEventListener("input", function() {
        if(this.value.length >= 1) { 
            checkForDuplicateId();
        } else {
            numeroIdInput.classList.remove("has-error");
            numeroIdAlert.style.display = "none";
        }
    });
}

function checkForDuplicateId() {
    const numeroIdInput = document.getElementById("numero_identificacion");
    const numeroIdAlert = document.getElementById("numero_identificacion_alert");
    const idValue = numeroIdInput.value;
    
    if(!idValue) return false;
    
    const isDuplicate = existingData.some(item => item.numero_identificacion === idValue);
    
    if(isDuplicate) {
        numeroIdInput.classList.add("has-error");
        numeroIdAlert.style.display = "block";
        return true;
    } else {
        numeroIdInput.classList.remove("has-error");
        numeroIdAlert.style.display = "none";
        return false;
    }
}

function generarID() {
    const fecha = new Date();
    const fechaStr = fecha.toISOString().slice(0,10).replace(/-/g,"");
    const randomHex = Math.floor(Math.random() * 0xFFFF).toString(16).toUpperCase().padStart(4,"0");
    return `OF-${fechaStr}-${randomHex}`;
}

function getFechaHoraActual() {
    const ahora = new Date();
    const dia = ahora.getDate().toString().padStart(2,"0");
    const mes = (ahora.getMonth()+1).toString().padStart(2,"0");
    const año = ahora.getFullYear();
    const horas = ahora.getHours().toString().padStart(2,"0");
    const minutos = ahora.getMinutes().toString().padStart(2,"0");
    return `${dia}/${mes}/${año} ${horas}:${minutos}`;
}

document.getElementById("agregar-calle").addEventListener("click", function() {
    const container = document.getElementById("calles-container");
    const nuevoGrupo = document.createElement("div");
    nuevoGrupo.className = "calle-periodo-group";
    
    nuevoGrupo.innerHTML = `
        <div class=form-group>
            <label>Calle(s)</label>
            <textarea class=calle-text rows=2 required placeholder="Ej: Av. Corrientes 1200"></textarea>
        </div>
        <div class=date-time-range>
            <div>
                <label>Fecha Inicio</label>
                <input type=date class=fecha-inicio required>
            </div>
            <div>
                <label>Hora Inicio</label>
                <input type=time class=hora-inicio required>
            </div>
            <div>
                <label>Fecha Fin</label>
                <input type=date class=fecha-fin required>
            </div>
            <div>
                <label>Hora Fin</label>
                <input type=time class=hora-fin required>
            </div>
        </div>
        <button type=button class=eliminar-calle>
            <i class="fas fa-trash"></i> Eliminar
        </button>
    `;
    
    container.appendChild(nuevoGrupo);
    
    nuevoGrupo.querySelector(".eliminar-calle").addEventListener("click", function() {
        if(confirm("¿Eliminar grupo?")) {
            nuevoGrupo.remove();
        }
    });
});

document.getElementById("oficioForm").addEventListener("submit", async function(e) {
    e.preventDefault();
    
    if(checkForDuplicateId()) {
        alert("Error: N° de ID duplicado");
        document.getElementById("numero_identificacion").focus();
        return;
    }
    
    const fiscaliaSelect = document.getElementById("fiscalia");
    let fiscaliaValue = fiscaliaSelect.value;
    
    if(fiscaliaValue === "OTRO") {
        const otraFiscalia = document.getElementById("otra_fiscalia").value.trim();
        if(!otraFiscalia) {
            alert("Debe especificar la fiscalía cuando selecciona 'OTRO'");
            document.getElementById("otra_fiscalia").focus();
            return;
        }
        fiscaliaValue = `OTRO: ${otraFiscalia}`; 
    }
    
    const estadoMaterial = document.getElementById("estado_material").value;
    let detallesEstado = "";
    
    if(estadoMaterial === "Rechazado por Irregularidades") {
        detallesEstado = `Rechazado: ${document.getElementById("motivo_rechazo").value}`;
    } else if(estadoMaterial === "No se dispone de material") {
        detallesEstado = `No disponible: ${document.getElementById("tipo_no_disponible").value}`;
    } else {
        detallesEstado = estadoMaterial;
    }
    
    const grupos = document.querySelectorAll(".calle-periodo-group");
    
    try {
        for(const grupo of grupos) {
            const formData = {
                id: generarID(),
                numero_oficio: document.getElementById("numero_oficio").value,
                numero_identificacion: document.getElementById("numero_identificacion").value,
                fiscalia: fiscaliaValue,
                caratula: document.getElementById("caratula").value,
                calles: grupo.querySelector(".calle-text").value,
                fecha_inicio: grupo.querySelector(".fecha-inicio").value,
                hora_inicio: grupo.querySelector(".hora-inicio").value,
                fecha_fin: grupo.querySelector(".fecha-fin").value,
                hora_fin: grupo.querySelector(".hora-fin").value,
                camaras_aportadas: document.getElementById("camaras_aportadas").value,
                observaciones: document.getElementById("observaciones").value,
                estado_material: detallesEstado,
                fecha_carga: getFechaHoraActual(),
                timestamp: new Date().toISOString()
            };

            const response = await fetch(SHEETBEST_URL, {
                method: "POST",
                headers: {
                    "Content-Type": "application/json"
                },
                body: JSON.stringify(formData)
            });

            if(!response.ok) {
                throw new Error("Error al guardar");
            }
        }

        const refreshResponse = await fetch(SHEETBEST_URL);
        existingData = await refreshResponse.json();
        updatePendingCases();
        
        document.getElementById("successModal").style.display = "flex";
        document.getElementById("errorMessage").style.display = "none";
        document.getElementById("oficioForm").reset();
        document.getElementById("otraFiscaliaGroup").classList.add("hidden");
        document.getElementById("motivoRechazoGroup").classList.add("hidden");
        document.getElementById("tipoNoDisponibleGroup").classList.add("hidden");
        
    } catch(error) {
        document.getElementById("errorMessage").style.display = "block";
        document.getElementById("errorMessage").innerHTML = `
            <i class="fas fa-exclamation-circle"></i> Error: ${error.message || "Revise conexión"}
        `;
        console.error("Error:", error);
    }
});
</script>
</body>
</html>
